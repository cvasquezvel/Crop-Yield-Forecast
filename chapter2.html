<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.37">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Crop Yield Forecast in tidymodels - 3&nbsp; Modelamiento en tidymodels con el motor ranger.</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./chapter3.html" rel="next">
<link href="./chapter1.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="site_libs/core-js-2.5.3/shim.min.js"></script>
<script src="site_libs/react-17.0.0/react.min.js"></script>
<script src="site_libs/react-17.0.0/react-dom.min.js"></script>
<script src="site_libs/reactwidget-1.0.0/react-tools.js"></script>
<script src="site_libs/htmlwidgets-1.6.0/htmlwidgets.js"></script>
<link href="site_libs/reactable-0.4.1/reactable.css" rel="stylesheet">
<script src="site_libs/reactable-binding-0.4.1/reactable.js"></script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Modelamiento en tidymodels con el motor ranger.</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Crop Yield Forecast in tidymodels</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle sidebar-tool" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Prefacio</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introducción</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter1.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Modelamiento en tidymodels con el motor lm.</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter2.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Modelamiento en tidymodels con el motor ranger.</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapter3.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Revisión de muchos modelos y Ensamblado de modelos en tidymodels.</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#receta-de-preprocesamiento" id="toc-receta-de-preprocesamiento" class="nav-link active" data-scroll-target="#receta-de-preprocesamiento"> <span class="header-section-number">3.1</span> Receta de preprocesamiento</a></li>
  <li><a href="#random-forest" id="toc-random-forest" class="nav-link" data-scroll-target="#random-forest"> <span class="header-section-number">3.2</span> Random Forest</a>
  <ul class="collapse">
  <li><a href="#definir-especificaciones-del-modelo" id="toc-definir-especificaciones-del-modelo" class="nav-link" data-scroll-target="#definir-especificaciones-del-modelo"> <span class="header-section-number">3.2.1</span> Definir especificaciones del modelo</a></li>
  <li><a href="#definir-fórmula-del-modelo" id="toc-definir-fórmula-del-modelo" class="nav-link" data-scroll-target="#definir-fórmula-del-modelo"> <span class="header-section-number">3.2.2</span> Definir fórmula del modelo</a></li>
  <li><a href="#definir-flujo-de-trabajo" id="toc-definir-flujo-de-trabajo" class="nav-link" data-scroll-target="#definir-flujo-de-trabajo"> <span class="header-section-number">3.2.3</span> Definir flujo de trabajo</a></li>
  <li><a href="#extraer-el-conjunto-de-hiperparámetros-del-modelo" id="toc-extraer-el-conjunto-de-hiperparámetros-del-modelo" class="nav-link" data-scroll-target="#extraer-el-conjunto-de-hiperparámetros-del-modelo"> <span class="header-section-number">3.2.4</span> Extraer el conjunto de hiperparámetros del modelo</a></li>
  <li><a href="#búsqueda-del-mejor-conjunto-de-hiperparámtros-mediante-validación-cruzada" id="toc-búsqueda-del-mejor-conjunto-de-hiperparámtros-mediante-validación-cruzada" class="nav-link" data-scroll-target="#búsqueda-del-mejor-conjunto-de-hiperparámtros-mediante-validación-cruzada"> <span class="header-section-number">3.2.5</span> Búsqueda del mejor conjunto de Hiperparámtros mediante validación cruzada</a></li>
  <li><a href="#métricas-del-rendimiento-predictivo-en-fase-de-validación-cruzada" id="toc-métricas-del-rendimiento-predictivo-en-fase-de-validación-cruzada" class="nav-link" data-scroll-target="#métricas-del-rendimiento-predictivo-en-fase-de-validación-cruzada"> <span class="header-section-number">3.2.6</span> Métricas del rendimiento predictivo en fase de validación cruzada</a></li>
  <li><a href="#seleccionar-el-mejor-conjunto-de-hiperparámetros" id="toc-seleccionar-el-mejor-conjunto-de-hiperparámetros" class="nav-link" data-scroll-target="#seleccionar-el-mejor-conjunto-de-hiperparámetros"> <span class="header-section-number">3.2.7</span> Seleccionar el mejor conjunto de hiperparámetros</a></li>
  <li><a href="#métricas-del-rendimiento-predictivo-para-el-mejor-conjunto-de-hiperparámetros" id="toc-métricas-del-rendimiento-predictivo-para-el-mejor-conjunto-de-hiperparámetros" class="nav-link" data-scroll-target="#métricas-del-rendimiento-predictivo-para-el-mejor-conjunto-de-hiperparámetros"> <span class="header-section-number">3.2.8</span> Métricas del rendimiento predictivo para el mejor conjunto de hiperparámetros</a></li>
  <li><a href="#entrenamiento-del-modelo-final" id="toc-entrenamiento-del-modelo-final" class="nav-link" data-scroll-target="#entrenamiento-del-modelo-final"> <span class="header-section-number">3.2.9</span> Entrenamiento del modelo final</a></li>
  <li><a href="#variables-más-importantes" id="toc-variables-más-importantes" class="nav-link" data-scroll-target="#variables-más-importantes"> <span class="header-section-number">3.2.10</span> Variables más importantes</a></li>
  <li><a href="#modificar-la-receta-de-preprocesamiento" id="toc-modificar-la-receta-de-preprocesamiento" class="nav-link" data-scroll-target="#modificar-la-receta-de-preprocesamiento"> <span class="header-section-number">3.2.11</span> Modificar la receta de preprocesamiento</a></li>
  <li><a href="#redefinir-flujo-de-trabajo" id="toc-redefinir-flujo-de-trabajo" class="nav-link" data-scroll-target="#redefinir-flujo-de-trabajo"> <span class="header-section-number">3.2.12</span> Redefinir flujo de trabajo</a></li>
  <li><a href="#extraer-el-conjunto-de-hiperparámetros-del-modelo-con-el-mejor-conjunto-de-variables" id="toc-extraer-el-conjunto-de-hiperparámetros-del-modelo-con-el-mejor-conjunto-de-variables" class="nav-link" data-scroll-target="#extraer-el-conjunto-de-hiperparámetros-del-modelo-con-el-mejor-conjunto-de-variables"> <span class="header-section-number">3.2.13</span> Extraer el conjunto de hiperparámetros del modelo con el mejor conjunto de variables</a></li>
  <li><a href="#repetir-búsqueda-del-mejor-conjunto-de-hiperparámtros-mediante-validación-cruzada" id="toc-repetir-búsqueda-del-mejor-conjunto-de-hiperparámtros-mediante-validación-cruzada" class="nav-link" data-scroll-target="#repetir-búsqueda-del-mejor-conjunto-de-hiperparámtros-mediante-validación-cruzada"> <span class="header-section-number">3.2.14</span> Repetir búsqueda del mejor conjunto de Hiperparámtros mediante validación cruzada</a></li>
  <li><a href="#métricas-del-rendimiento-predictivo-en-fase-de-validación-cruzada-con-el-mejor-conjunto-de-variables" id="toc-métricas-del-rendimiento-predictivo-en-fase-de-validación-cruzada-con-el-mejor-conjunto-de-variables" class="nav-link" data-scroll-target="#métricas-del-rendimiento-predictivo-en-fase-de-validación-cruzada-con-el-mejor-conjunto-de-variables"> <span class="header-section-number">3.2.15</span> Métricas del rendimiento predictivo en fase de validación cruzada con el mejor conjunto de variables</a></li>
  <li><a href="#seleccionar-el-mejor-conjunto-de-hiperparámetros-con-el-mejor-conjunto-de-variables" id="toc-seleccionar-el-mejor-conjunto-de-hiperparámetros-con-el-mejor-conjunto-de-variables" class="nav-link" data-scroll-target="#seleccionar-el-mejor-conjunto-de-hiperparámetros-con-el-mejor-conjunto-de-variables"> <span class="header-section-number">3.2.16</span> Seleccionar el mejor conjunto de hiperparámetros con el mejor conjunto de variables</a></li>
  <li><a href="#métricas-del-rendimiento-predictivo-para-el-mejor-conjunto-de-hiperparámetros-con-el-mejor-conjunto-de-variables" id="toc-métricas-del-rendimiento-predictivo-para-el-mejor-conjunto-de-hiperparámetros-con-el-mejor-conjunto-de-variables" class="nav-link" data-scroll-target="#métricas-del-rendimiento-predictivo-para-el-mejor-conjunto-de-hiperparámetros-con-el-mejor-conjunto-de-variables"> <span class="header-section-number">3.2.17</span> Métricas del rendimiento predictivo para el mejor conjunto de hiperparámetros con el mejor conjunto de variables</a></li>
  <li><a href="#entrenamiento-del-modelo-final-con-el-mejor-conjunto-de-variables" id="toc-entrenamiento-del-modelo-final-con-el-mejor-conjunto-de-variables" class="nav-link" data-scroll-target="#entrenamiento-del-modelo-final-con-el-mejor-conjunto-de-variables"> <span class="header-section-number">3.2.18</span> Entrenamiento del modelo final con el mejor conjunto de variables</a></li>
  <li><a href="#verificación-de-la-importancia-de-variables" id="toc-verificación-de-la-importancia-de-variables" class="nav-link" data-scroll-target="#verificación-de-la-importancia-de-variables"> <span class="header-section-number">3.2.19</span> Verificación de la importancia de variables</a></li>
  <li><a href="#testeo-interno" id="toc-testeo-interno" class="nav-link" data-scroll-target="#testeo-interno"> <span class="header-section-number">3.2.20</span> Testeo interno</a></li>
  <li><a href="#recalibración-inicial-del-modelo" id="toc-recalibración-inicial-del-modelo" class="nav-link" data-scroll-target="#recalibración-inicial-del-modelo"> <span class="header-section-number">3.2.21</span> Recalibración inicial del modelo</a></li>
  <li><a href="#testeo-externo" id="toc-testeo-externo" class="nav-link" data-scroll-target="#testeo-externo"> <span class="header-section-number">3.2.22</span> Testeo externo</a></li>
  </ul></li>
  <li><a href="#discusión" id="toc-discusión" class="nav-link" data-scroll-target="#discusión"> <span class="header-section-number">3.3</span> Discusión</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Modelamiento en tidymodels con el motor ranger.</span></h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p><strong>Caso: Plant spatial traits, bee species composition, and weather conditions dataset for wild blueberry yield prediction through computer simulation modeling and machine learning algorithms (Obsie &amp; Drummond, 2020)</strong></p>
<div class="cell">

</div>
<div class="cell">

</div>
<div class="cell">

</div>
<div class="cell">

</div>
<div class="cell">

</div>
<section id="receta-de-preprocesamiento" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="receta-de-preprocesamiento"><span class="header-section-number">3.1</span> Receta de preprocesamiento</h2>
<p>En este caso, evitaré transformar a la variable respuesta con la función “log”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Recipe ----</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>data_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="at">formula =</span> <span class="st">`</span><span class="at">yield</span><span class="st">`</span> <span class="sc">~</span> .,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">x =</span> data_train) <span class="sc">%&gt;%</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_select</span>(<span class="fu">where</span>(base<span class="sc">::</span>is.numeric)) <span class="sc">%&gt;%</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># step_nzv(all_predictors(),</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#          -all_outcomes()) %&gt;%</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># step_zv(all_predictors(),</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#          -all_outcomes()) %&gt;%</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate_at</span>(<span class="fu">where</span>(base<span class="sc">::</span>is.numeric),</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>                 <span class="sc">-</span><span class="fu">contains</span>(<span class="fu">c</span>(<span class="st">"yield"</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"RainingDays"</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"AverageRainingDays"</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"honeybee"</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"bumbles"</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"andrena"</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"osmia"</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"fruitset"</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"fruitmass"</span>)),</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fn =</span> <span class="sc">~</span><span class="fu">log</span>(.))</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>data_prep <span class="ot">&lt;-</span> <span class="fu">prep</span>(data_rec)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>data_train_prep <span class="ot">&lt;-</span> <span class="fu">juice</span>(data_prep)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># data_train_prep &lt;- bake(data_prep, new_data = data_train)</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>data_test_prep  <span class="ot">&lt;-</span> <span class="fu">bake</span>(data_prep, <span class="at">new_data =</span> data_test)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>data_new_prep  <span class="ot">&lt;-</span> <span class="fu">bake</span>(data_prep, <span class="at">new_data =</span> data_new)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="random-forest" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="random-forest"><span class="header-section-number">3.2</span> Random Forest</h2>
<p>En esta sección, veremos como se entrenan, validen y testean modelos no paramétricos, tomando como ejemplo el algoritmo Random Forest. Omitiré muchas cosas del capítulo anterior por ser redundantes.</p>
<section id="definir-especificaciones-del-modelo" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="definir-especificaciones-del-modelo"><span class="header-section-number">3.2.1</span> Definir especificaciones del modelo</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicializar un objeto de regresión lineal</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>rf_model_spec <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="fu">tune</span>(), </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="fu">tune</span>(), </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">tune</span>()</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Establecer el modelo de motor</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">'ranger'</span>,                         </span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">importance =</span> <span class="st">"permutation"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Establecer el modo de modelo</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">'regression'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="definir-fórmula-del-modelo" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="definir-fórmula-del-modelo"><span class="header-section-number">3.2.2</span> Definir fórmula del modelo</h3>
<p>A diferencia del capítulo con el motor lm, el motor ranger permite usar al algoritmo Random Forest y este último puede seleccionar a las mejores variables según importancia mediante permutación.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>formula_rf <span class="ot">=</span> yield <span class="sc">~</span> .  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="definir-flujo-de-trabajo" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="definir-flujo-de-trabajo"><span class="header-section-number">3.2.3</span> Definir flujo de trabajo</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>rf_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(data_rec) <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(rf_model_spec,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">formula =</span> formula_rf) </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tune_args</span>(rf_wf) <span class="co">#obtener todos los argumentos ajustables posibles en el flujo de trabajo</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  name  tunable id    source     component   component_id
  &lt;chr&gt; &lt;lgl&gt;   &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;       &lt;chr&gt;       
1 mtry  TRUE    mtry  model_spec rand_forest &lt;NA&gt;        
2 trees TRUE    trees model_spec rand_forest &lt;NA&gt;        
3 min_n TRUE    min_n model_spec rand_forest &lt;NA&gt;        </code></pre>
</div>
</div>
</section>
<section id="extraer-el-conjunto-de-hiperparámetros-del-modelo" class="level3" data-number="3.2.4">
<h3 data-number="3.2.4" class="anchored" data-anchor-id="extraer-el-conjunto-de-hiperparámetros-del-modelo"><span class="header-section-number">3.2.4</span> Extraer el conjunto de hiperparámetros del modelo</h3>
<p>Similar a lo que se realizó con la regresión Lasso. En este caso, definimos un rango de árboles que irá de 50 a 150 solo para hacer más rápida la búsqueda de hiperparámetros. Este método requiere que finalicemos la búsqueda con mtry (número de predictores)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>rf_params <span class="ot">&lt;-</span> hardhat<span class="sc">::</span><span class="fu">extract_parameter_set_dials</span>(rf_wf) <span class="sc">%&gt;%</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>(<span class="at">trees =</span> <span class="fu">trees</span>(<span class="at">range =</span> <span class="fu">c</span>(50L, 150L)))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>rf_params <span class="ot">&lt;-</span> rf_params <span class="sc">%&gt;%</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  dials<span class="sc">::</span><span class="fu">finalize</span>(rf_params)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>rf_params</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Collection of 3 parameters for tuning

 identifier  type    object
       mtry  mtry nparam[+]
      trees trees nparam[+]
      min_n min_n nparam[+]</code></pre>
</div>
</div>
</section>
<section id="búsqueda-del-mejor-conjunto-de-hiperparámtros-mediante-validación-cruzada" class="level3" data-number="3.2.5">
<h3 data-number="3.2.5" class="anchored" data-anchor-id="búsqueda-del-mejor-conjunto-de-hiperparámtros-mediante-validación-cruzada"><span class="header-section-number">3.2.5</span> Búsqueda del mejor conjunto de Hiperparámtros mediante validación cruzada</h3>
<p>En este paso se hará uso de la optimización bayesiana de hiperparámetros, el cual considero que es un proceso más sofisticado y menos costoso que la búsqueda de hiperparámetros regular o por grillas.</p>
<div class="cell">

</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2020</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">tic</span>()</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>rf_tune <span class="ot">&lt;-</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  rf_wf <span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_bayes</span>(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> data_folds,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">param_info =</span> rf_params,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># por defecto es 5 (número aleatorio de combinaciones (puntos de grilla) de hiperparámetros)</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">initial =</span> <span class="dv">5</span>, </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="dv">50</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> multi_met, <span class="co"># metric_set(rmse,mae,smape),</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">control_bayes</span>(</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>      <span class="co"># El corte entero para el número de iteraciones sin mejores resultados.</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">no_improve =</span> <span class="dv">10</span>,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">extract =</span> identity,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">save_pred =</span> <span class="cn">TRUE</span>,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">verbose =</span> TRUE<span class="co">#,</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>      <span class="co"># parallel_over = "resamples"</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>❯  Generating a set of 5 initial parameter results</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Initialization complete</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 1 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=179.8 (@iter 0)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4503 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=6, trees=52, min_n=13</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>♥ Newest results:   rmse=166.7 (+/-21.7)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 2 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=166.7 (@iter 1)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4467 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=4, trees=145, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>♥ Newest results:   rmse=148.8 (+/-19.2)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 3 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=148.8 (@iter 2)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4469 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=5, trees=148, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>♥ Newest results:   rmse=146.7 (+/-19.9)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 4 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=146.7 (@iter 3)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4443 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=6, trees=126, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>♥ Newest results:   rmse=140.9 (+/-16.2)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 5 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=140.9 (@iter 4)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4478 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=6, trees=58, min_n=3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=143.3 (+/-18.4)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 6 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=140.9 (@iter 4)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4483 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=6, trees=83, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=149.4 (+/-19.5)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 7 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=140.9 (@iter 4)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4451 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=6, trees=133, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=142.5 (+/-17.9)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 8 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=140.9 (@iter 4)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4491 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=5, trees=51, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=142.2 (+/-18.7)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 9 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=140.9 (@iter 4)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4465 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=6, trees=52, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>♥ Newest results:   rmse=140.5 (+/-17.5)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 10 ────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=140.5 (@iter 9)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4472 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=5, trees=121, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=146.2 (+/-20.1)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 11 ────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=140.5 (@iter 9)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4492 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=6, trees=149, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=147 (+/-18.3)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 12 ────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=140.5 (@iter 9)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4496 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=4, trees=53, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=157.4 (+/-22.5)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 13 ────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=140.5 (@iter 9)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4445 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=6, trees=107, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=143.2 (+/-16.9)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 14 ────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=140.5 (@iter 9)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4502 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=6, trees=123, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=143.9 (+/-17.7)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 15 ────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=140.5 (@iter 9)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4513 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=6, trees=61, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=141.9 (+/-17.7)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 16 ────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=140.5 (@iter 9)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4445 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=5, trees=129, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=144.4 (+/-17.3)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 17 ────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=140.5 (@iter 9)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4479 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=6, trees=116, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=145.3 (+/-17.4)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 18 ────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=140.5 (@iter 9)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4501 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=6, trees=57, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=140.7 (+/-17)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 19 ────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=140.5 (@iter 9)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4452 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=6, trees=67, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=149.1 (+/-18.7)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>! No improvement for 10 iterations; returning current results.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb242"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">toc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>270.1 sec elapsed</code></pre>
</div>
</div>
</section>
<section id="métricas-del-rendimiento-predictivo-en-fase-de-validación-cruzada" class="level3" data-number="3.2.6">
<h3 data-number="3.2.6" class="anchored" data-anchor-id="métricas-del-rendimiento-predictivo-en-fase-de-validación-cruzada"><span class="header-section-number">3.2.6</span> Métricas del rendimiento predictivo en fase de validación cruzada</h3>
<p>A partir de este paso tendremos un poco más de cuidado. Sucede que la búsqueda de hiperparámetros crea un objeto que almacena los resultados de cada conjunto de hiperparámetros contrastado en cada folio. Por ello, lo conveniente es primero tener el mejor conjunto de hiperparámetros para luego visualizar el performance predictivo de este mejor conjunto dentro de cada folio.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(rf_bayes_tune)</span></span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(rf_tune)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter2_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a>rf_tune <span class="sc">%&gt;%</span></span>
<span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb245-3"><a href="#cb245-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>std_err) <span class="sc">%&gt;%</span></span>
<span id="cb245-4"><a href="#cb245-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> .metric,</span>
<span id="cb245-5"><a href="#cb245-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> <span class="fu">c</span>(mean)) <span class="sc">%&gt;%</span></span>
<span id="cb245-6"><a href="#cb245-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(.metric == "rmse") %&gt;%</span></span>
<span id="cb245-7"><a href="#cb245-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(base<span class="sc">::</span>is.numeric, round, <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb245-8"><a href="#cb245-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(rmse) <span class="sc">%&gt;%</span></span>
<span id="cb245-9"><a href="#cb245-9" aria-hidden="true" tabindex="-1"></a>  reactable<span class="sc">::</span><span class="fu">reactable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div class="reactable html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-a5c81359d1e696476072" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-a5c81359d1e696476072">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"mtry":[6,6,6,6,5,6,6,6,6,5,6,5,5,6,4,6,6,4,6,6,3,5,3,1],"trees":[52,57,126,61,51,133,107,58,123,129,116,121,148,149,145,67,83,53,52,59,147,97,86,112],"min_n":[2,2,2,2,2,2,2,3,2,2,2,2,2,2,2,2,2,2,13,18,5,32,34,11],".estimator":["standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard"],"n":[20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20],".config":["Iter9","Iter18","Iter4","Iter15","Iter8","Iter7","Iter13","Iter5","Iter14","Iter16","Iter17","Iter10","Iter3","Iter11","Iter2","Iter19","Iter6","Iter12","Iter1","Preprocessor1_Model5","Preprocessor1_Model3","Preprocessor1_Model2","Preprocessor1_Model1","Preprocessor1_Model4"],".iter":[9,18,4,15,8,7,13,5,14,16,17,10,3,11,2,19,6,12,1,0,0,0,0,0],"mae":[101.921,102.108,102.519,103.1,101.707,102.869,103.033,102.239,102.69,102.808,105.036,104.253,103.893,104.42,106.043,106.267,106.503,110.123,117.881,127.507,124.604,160.106,199.824,372.907],"mape":[1.924,1.922,1.905,1.93,1.93,1.931,1.937,1.948,1.949,1.955,1.963,2.024,2.004,1.979,2.055,2.007,2.032,2.158,2.273,2.486,2.477,3.137,3.904,6.885],"rmse":[140.468,140.663,140.911,141.934,142.155,142.527,143.199,143.305,143.935,144.429,145.274,146.17,146.696,146.974,148.785,149.135,149.436,157.364,166.701,179.849,183.188,230.982,291.064,488.396],"rsq":[0.989,0.989,0.989,0.989,0.989,0.989,0.989,0.989,0.989,0.989,0.988,0.989,0.988,0.988,0.988,0.988,0.988,0.986,0.984,0.982,0.981,0.97,0.956,0.928]},"columns":[{"id":"mtry","name":"mtry","type":"numeric"},{"id":"trees","name":"trees","type":"numeric"},{"id":"min_n","name":"min_n","type":"numeric"},{"id":".estimator","name":".estimator","type":"character"},{"id":"n","name":"n","type":"numeric"},{"id":".config","name":".config","type":"character"},{"id":".iter","name":".iter","type":"numeric"},{"id":"mae","name":"mae","type":"numeric"},{"id":"mape","name":"mape","type":"numeric"},{"id":"rmse","name":"rmse","type":"numeric"},{"id":"rsq","name":"rsq","type":"numeric"}],"dataKey":"49ef868deffd634f0c006ee26f9c81d8"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
</div>
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>rf_tune <span class="sc">%&gt;%</span></span>
<span id="cb246-2"><a href="#cb246-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb246-3"><a href="#cb246-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(.metric == "rmse") %&gt;%</span></span>
<span id="cb246-4"><a href="#cb246-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.metric, mean, std_err, min_n, mtry, trees</span>
<span id="cb246-5"><a href="#cb246-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb246-6"><a href="#cb246-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(min_n<span class="sc">:</span>mtry<span class="sc">:</span>trees,</span>
<span id="cb246-7"><a href="#cb246-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>,</span>
<span id="cb246-8"><a href="#cb246-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"parameter"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb246-9"><a href="#cb246-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(value, mean, <span class="at">color =</span> parameter)) <span class="sc">+</span></span>
<span id="cb246-10"><a href="#cb246-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb246-11"><a href="#cb246-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb246-12"><a href="#cb246-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err,</span>
<span id="cb246-13"><a href="#cb246-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ymax =</span> mean <span class="sc">+</span> std_err)) <span class="sc">+</span></span>
<span id="cb246-14"><a href="#cb246-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(.metric<span class="sc">~</span>parameter, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb246-15"><a href="#cb246-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"RMSE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in x:y: numerical expression has 2 elements: only the first used</code></pre>
</div>
<div class="cell-output-display">
<p><img src="chapter2_files/figure-html/unnamed-chunk-13-3.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="seleccionar-el-mejor-conjunto-de-hiperparámetros" class="level3" data-number="3.2.7">
<h3 data-number="3.2.7" class="anchored" data-anchor-id="seleccionar-el-mejor-conjunto-de-hiperparámetros"><span class="header-section-number">3.2.7</span> Seleccionar el mejor conjunto de hiperparámetros</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a>best_rf_model <span class="ot">&lt;-</span> <span class="fu">select_best</span>(rf_tune, <span class="st">"rmse"</span>)</span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>final_rf <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(rf_wf,</span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a>                              best_rf_model)</span>
<span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a>final_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: rand_forest()

── Preprocessor ────────────────────────────────────────────────────────────────
2 Recipe Steps

• step_select()
• step_mutate_at()

── Model ───────────────────────────────────────────────────────────────────────
Random Forest Model Specification (regression)

Main Arguments:
  mtry = 6
  trees = 52
  min_n = 2

Engine-Specific Arguments:
  importance = permutation

Computational engine: ranger </code></pre>
</div>
</div>
</section>
<section id="métricas-del-rendimiento-predictivo-para-el-mejor-conjunto-de-hiperparámetros" class="level3" data-number="3.2.8">
<h3 data-number="3.2.8" class="anchored" data-anchor-id="métricas-del-rendimiento-predictivo-para-el-mejor-conjunto-de-hiperparámetros"><span class="header-section-number">3.2.8</span> Métricas del rendimiento predictivo para el mejor conjunto de hiperparámetros</h3>
<p>Ahora rescatamos las métricas del rendimiento predictivo solo para el mejor conjunto de hiperparámetros en la fase de validación cruzada.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Métricas promedio de todas las particiones</span></span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a>metrics_rf <span class="ot">&lt;-</span> </span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a>  rf_tune <span class="sc">%&gt;%</span> </span>
<span id="cb250-4"><a href="#cb250-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>(<span class="at">summarize =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb250-5"><a href="#cb250-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">modelo =</span> <span class="st">"rf"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb250-6"><a href="#cb250-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(.estimator,.config)) <span class="sc">%&gt;%</span></span>
<span id="cb250-7"><a href="#cb250-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(mtry <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>mtry,</span>
<span id="cb250-8"><a href="#cb250-8" aria-hidden="true" tabindex="-1"></a>                min_n <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>min_n,</span>
<span id="cb250-9"><a href="#cb250-9" aria-hidden="true" tabindex="-1"></a>                trees <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>trees)</span>
<span id="cb250-10"><a href="#cb250-10" aria-hidden="true" tabindex="-1"></a>metrics_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 9
   mtry trees min_n .metric    mean     n  std_err .iter modelo
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;int&gt;    &lt;dbl&gt; &lt;int&gt; &lt;chr&gt; 
1     6    52     2 mae     102.       20  7.05        9 rf    
2     6    52     2 mape      1.92     20  0.348       9 rf    
3     6    52     2 rmse    140.       20 17.5         9 rf    
4     6    52     2 rsq       0.989    20  0.00197     9 rf    </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Métricas individuales de cada una de las particiones</span></span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a>metrics_rf_complete <span class="ot">&lt;-</span> </span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a>  rf_tune <span class="sc">%&gt;%</span> </span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>(<span class="at">summarize =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb252-5"><a href="#cb252-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">modelo =</span> <span class="st">"rf"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb252-6"><a href="#cb252-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(.config)) <span class="sc">%&gt;%</span> </span>
<span id="cb252-7"><a href="#cb252-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id, mtry, min_n, trees, .metric) <span class="sc">%&gt;%</span></span>
<span id="cb252-8"><a href="#cb252-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(<span class="fu">c</span>(.estimate),</span>
<span id="cb252-9"><a href="#cb252-9" aria-hidden="true" tabindex="-1"></a>                                 mean)) <span class="sc">%&gt;%</span></span>
<span id="cb252-10"><a href="#cb252-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(mtry <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>mtry,</span>
<span id="cb252-11"><a href="#cb252-11" aria-hidden="true" tabindex="-1"></a>                min_n <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>min_n,</span>
<span id="cb252-12"><a href="#cb252-12" aria-hidden="true" tabindex="-1"></a>                trees <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>trees)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'id', 'mtry', 'min_n', 'trees'. You can
override using the `.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>metrics_rf_complete</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 80 × 6
# Groups:   id, mtry, min_n, trees [20]
   id      mtry min_n trees .metric .estimate
   &lt;chr&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt;
 1 Fold01     6     2    52 mae       137.   
 2 Fold01     6     2    52 mape        2.23 
 3 Fold01     6     2    52 rmse      213.   
 4 Fold01     6     2    52 rsq         0.978
 5 Fold02     6     2    52 mae       100.   
 6 Fold02     6     2    52 mape        1.95 
 7 Fold02     6     2    52 rmse      150.   
 8 Fold02     6     2    52 rsq         0.992
 9 Fold03     6     2    52 mae        90.7  
10 Fold03     6     2    52 mape        1.35 
# … with 70 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Valores de validación (mae y rmse) obtenidos en cada partición y repetición.</span></span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> metrics_rf_complete,</span>
<span id="cb256-4"><a href="#cb256-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> .estimate, <span class="at">fill =</span> .metric)) <span class="sc">+</span></span>
<span id="cb256-5"><a href="#cb256-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb256-6"><a href="#cb256-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb256-7"><a href="#cb256-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(. <span class="sc">~</span> .metric, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb256-8"><a href="#cb256-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb256-9"><a href="#cb256-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> metrics_rf <span class="sc">%&gt;%</span> </span>
<span id="cb256-10"><a href="#cb256-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="st">".estimate"</span> <span class="ot">=</span> <span class="st">"mean"</span>),</span>
<span id="cb256-11"><a href="#cb256-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">xintercept =</span> .estimate, <span class="at">colour =</span> .metric), <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="dv">1</span>,</span>
<span id="cb256-12"><a href="#cb256-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="dv">2</span></span>
<span id="cb256-13"><a href="#cb256-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb256-14"><a href="#cb256-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x=</span><span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">90</span>, <span class="at">hjust=</span><span class="fl">0.5</span>))</span>
<span id="cb256-15"><a href="#cb256-15" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb256-16"><a href="#cb256-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> metrics_rf_complete,</span>
<span id="cb256-17"><a href="#cb256-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> .metric, <span class="at">y =</span> .estimate, <span class="at">fill =</span> .metric, <span class="at">color =</span> .metric)) <span class="sc">+</span></span>
<span id="cb256-18"><a href="#cb256-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">outlier.shape =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb256-19"><a href="#cb256-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">width =</span> <span class="fl">0.05</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb256-20"><a href="#cb256-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># coord_flip() +</span></span>
<span id="cb256-21"><a href="#cb256-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb256-22"><a href="#cb256-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> metrics_rf <span class="sc">%&gt;%</span> </span>
<span id="cb256-23"><a href="#cb256-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="st">".estimate"</span> <span class="ot">=</span> <span class="st">"mean"</span>),</span>
<span id="cb256-24"><a href="#cb256-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb256-25"><a href="#cb256-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb256-26"><a href="#cb256-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb256-27"><a href="#cb256-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(.metric <span class="sc">~</span> ., <span class="at">scales =</span> <span class="st">"free"</span>) </span>
<span id="cb256-28"><a href="#cb256-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb256-29"><a href="#cb256-29" aria-hidden="true" tabindex="-1"></a>ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(p1, p2, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">common.legend =</span> <span class="cn">TRUE</span>, <span class="at">align =</span> <span class="st">"v"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb256-30"><a href="#cb256-30" aria-hidden="true" tabindex="-1"></a>  ggpubr<span class="sc">::</span><span class="fu">annotate_figure</span>(</span>
<span id="cb256-31"><a href="#cb256-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">top =</span> ggpubr<span class="sc">::</span><span class="fu">text_grob</span>(<span class="st">"Distribución errores de validación cruzada"</span>, <span class="at">size =</span> <span class="dv">15</span>)</span>
<span id="cb256-32"><a href="#cb256-32" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter2_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb257"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a>validation_rf_predictions <span class="ot">&lt;-</span> </span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a>  rf_tune <span class="sc">%&gt;%</span> </span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a>  tune<span class="sc">::</span><span class="fu">collect_predictions</span>(<span class="at">summarize =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">modelo =</span> <span class="st">"rf"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(mtry <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>mtry,</span>
<span id="cb257-6"><a href="#cb257-6" aria-hidden="true" tabindex="-1"></a>                min_n <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>min_n,</span>
<span id="cb257-7"><a href="#cb257-7" aria-hidden="true" tabindex="-1"></a>                trees <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>trees)</span>
<span id="cb257-8"><a href="#cb257-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-9"><a href="#cb257-9" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb257-10"><a href="#cb257-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> validation_rf_predictions,</span>
<span id="cb257-11"><a href="#cb257-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> yield, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb257-12"><a href="#cb257-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb257-13"><a href="#cb257-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"firebrick"</span>) <span class="sc">+</span></span>
<span id="cb257-14"><a href="#cb257-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Valor predicho vs valor real"</span>) <span class="sc">+</span></span>
<span id="cb257-15"><a href="#cb257-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb257-16"><a href="#cb257-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-17"><a href="#cb257-17" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb257-18"><a href="#cb257-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> validation_rf_predictions,</span>
<span id="cb257-19"><a href="#cb257-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> .row, <span class="at">y =</span> yield <span class="sc">-</span> .pred)</span>
<span id="cb257-20"><a href="#cb257-20" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb257-21"><a href="#cb257-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb257-22"><a href="#cb257-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span>  <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"firebrick"</span>) <span class="sc">+</span></span>
<span id="cb257-23"><a href="#cb257-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residuos del modelo"</span>) <span class="sc">+</span></span>
<span id="cb257-24"><a href="#cb257-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb257-25"><a href="#cb257-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-26"><a href="#cb257-26" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb257-27"><a href="#cb257-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> validation_rf_predictions,</span>
<span id="cb257-28"><a href="#cb257-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> yield <span class="sc">-</span> .pred)</span>
<span id="cb257-29"><a href="#cb257-29" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb257-30"><a href="#cb257-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span> </span>
<span id="cb257-31"><a href="#cb257-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribución residuos del modelo"</span>) <span class="sc">+</span></span>
<span id="cb257-32"><a href="#cb257-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb257-33"><a href="#cb257-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-34"><a href="#cb257-34" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb257-35"><a href="#cb257-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> validation_rf_predictions,</span>
<span id="cb257-36"><a href="#cb257-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">sample =</span> yield <span class="sc">-</span> .pred)</span>
<span id="cb257-37"><a href="#cb257-37" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb257-38"><a href="#cb257-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_qq</span>() <span class="sc">+</span></span>
<span id="cb257-39"><a href="#cb257-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_qq_line</span>(<span class="at">color =</span> <span class="st">"firebrick"</span>) <span class="sc">+</span></span>
<span id="cb257-40"><a href="#cb257-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Q-Q residuos del modelo"</span>) <span class="sc">+</span></span>
<span id="cb257-41"><a href="#cb257-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb257-42"><a href="#cb257-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb257-43"><a href="#cb257-43" aria-hidden="true" tabindex="-1"></a>ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(<span class="at">plotlist =</span> <span class="fu">list</span>(p1, p2, p3, p4)) <span class="sc">%&gt;%</span></span>
<span id="cb257-44"><a href="#cb257-44" aria-hidden="true" tabindex="-1"></a>  ggpubr<span class="sc">::</span><span class="fu">annotate_figure</span>(</span>
<span id="cb257-45"><a href="#cb257-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">top =</span> ggpubr<span class="sc">::</span><span class="fu">text_grob</span>(<span class="st">"Distribución residuos"</span>, <span class="at">size =</span> <span class="dv">15</span>, <span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb257-46"><a href="#cb257-46" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter2_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="entrenamiento-del-modelo-final" class="level3" data-number="3.2.9">
<h3 data-number="3.2.9" class="anchored" data-anchor-id="entrenamiento-del-modelo-final"><span class="header-section-number">3.2.9</span> Entrenamiento del modelo final</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb258"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a>rf_model <span class="ot">&lt;-</span> final_rf <span class="sc">%&gt;%</span></span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(data_train) <span class="sc">%&gt;%</span></span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="variables-más-importantes" class="level3" data-number="3.2.10">
<h3 data-number="3.2.10" class="anchored" data-anchor-id="variables-más-importantes"><span class="header-section-number">3.2.10</span> Variables más importantes</h3>
<p>Ya que hemos creado un modelo con todas las variables, es necesario revisar si existe alguna variable que aporta de forma negativa en el performance predictivo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb259"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="co"># vip::vip(rf_model, num_features = 60)</span></span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-3"><a href="#cb259-3" aria-hidden="true" tabindex="-1"></a>vi_rf <span class="ot">&lt;-</span> </span>
<span id="cb259-4"><a href="#cb259-4" aria-hidden="true" tabindex="-1"></a>  rf_model <span class="sc">%&gt;%</span></span>
<span id="cb259-5"><a href="#cb259-5" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vi</span>() <span class="sc">%&gt;%</span></span>
<span id="cb259-6"><a href="#cb259-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Sign =</span> <span class="fu">ifelse</span>(Importance <span class="sc">&gt;=</span> <span class="dv">0</span>, <span class="st">"POS"</span>, <span class="st">"NEG"</span>),</span>
<span id="cb259-7"><a href="#cb259-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Importance =</span> <span class="fu">abs</span>(Importance),</span>
<span id="cb259-8"><a href="#cb259-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Variable =</span> <span class="fu">fct_reorder</span>(Variable, Importance),</span>
<span id="cb259-9"><a href="#cb259-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total_Importance =</span> <span class="fu">sum</span>(Importance),</span>
<span id="cb259-10"><a href="#cb259-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Importance =</span> Importance<span class="sc">/</span>Total_Importance) <span class="sc">%&gt;%</span></span>
<span id="cb259-11"><a href="#cb259-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dplyr::filter(!Importance == 0) %&gt;%</span></span>
<span id="cb259-12"><a href="#cb259-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Importance,</span>
<span id="cb259-13"><a href="#cb259-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> Variable,</span>
<span id="cb259-14"><a href="#cb259-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">fill =</span> Sign)) <span class="sc">+</span></span>
<span id="cb259-15"><a href="#cb259-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb259-16"><a href="#cb259-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(Importance,<span class="dv">4</span>),</span>
<span id="cb259-17"><a href="#cb259-17" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> Variable),</span>
<span id="cb259-18"><a href="#cb259-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb259-19"><a href="#cb259-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="st">"NEG"</span>,<span class="st">"POS"</span>),</span>
<span id="cb259-20"><a href="#cb259-20" aria-hidden="true" tabindex="-1"></a>                    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"red"</span>,<span class="st">"blue"</span>)) <span class="sc">+</span></span>
<span id="cb259-21"><a href="#cb259-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb259-22"><a href="#cb259-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="cn">NULL</span>)</span>
<span id="cb259-23"><a href="#cb259-23" aria-hidden="true" tabindex="-1"></a>vi_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter2_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Se observa que todas las variables aportan de forma positiva salvo “andrena”. En este caso, como “andrena” tiene importancia <strong>negativa</strong> se debe eliminar. Adicionalmente, se observa que las variables más imporantes fueron “fruitset”, “seeds” y “fruitmass”. Probaré repetir el proceso de entrenamiento, considerando las tres variables más importantes. El resto de variables con importancia positiva pero muy baja pueden llegar a tener importancia negativa en algún momento cuando se pruebe otros conjuntos de variables.</p>
</section>
<section id="modificar-la-receta-de-preprocesamiento" class="level3" data-number="3.2.11">
<h3 data-number="3.2.11" class="anchored" data-anchor-id="modificar-la-receta-de-preprocesamiento"><span class="header-section-number">3.2.11</span> Modificar la receta de preprocesamiento</h3>
<p>Con <em>step_selec</em> seleccionamos las tres variables más importantes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Recipe ----</span></span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a>data_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="at">formula =</span> <span class="st">`</span><span class="at">yield</span><span class="st">`</span> <span class="sc">~</span> .,</span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">x =</span> data_train) <span class="sc">%&gt;%</span></span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_select</span>(yield, fruitset, seeds, fruitmass) <span class="sc">%&gt;%</span></span>
<span id="cb260-6"><a href="#cb260-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate_at</span>(<span class="fu">where</span>(base<span class="sc">::</span>is.numeric),</span>
<span id="cb260-7"><a href="#cb260-7" aria-hidden="true" tabindex="-1"></a>                 <span class="sc">-</span><span class="fu">contains</span>(<span class="fu">c</span>(<span class="st">"yield"</span>,</span>
<span id="cb260-8"><a href="#cb260-8" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"fruitset"</span>,</span>
<span id="cb260-9"><a href="#cb260-9" aria-hidden="true" tabindex="-1"></a>                             <span class="st">"fruitmass"</span>)),</span>
<span id="cb260-10"><a href="#cb260-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fn =</span> <span class="sc">~</span><span class="fu">log</span>(.))</span>
<span id="cb260-11"><a href="#cb260-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-12"><a href="#cb260-12" aria-hidden="true" tabindex="-1"></a>data_prep <span class="ot">&lt;-</span> <span class="fu">prep</span>(data_rec)</span>
<span id="cb260-13"><a href="#cb260-13" aria-hidden="true" tabindex="-1"></a>data_train_prep <span class="ot">&lt;-</span> <span class="fu">juice</span>(data_prep)</span>
<span id="cb260-14"><a href="#cb260-14" aria-hidden="true" tabindex="-1"></a><span class="co"># data_train_prep &lt;- bake(data_prep, new_data = data_train)</span></span>
<span id="cb260-15"><a href="#cb260-15" aria-hidden="true" tabindex="-1"></a>data_test_prep  <span class="ot">&lt;-</span> <span class="fu">bake</span>(data_prep, <span class="at">new_data =</span> data_test)</span>
<span id="cb260-16"><a href="#cb260-16" aria-hidden="true" tabindex="-1"></a>data_new_prep  <span class="ot">&lt;-</span> <span class="fu">bake</span>(data_prep, <span class="at">new_data =</span> data_new)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="redefinir-flujo-de-trabajo" class="level3" data-number="3.2.12">
<h3 data-number="3.2.12" class="anchored" data-anchor-id="redefinir-flujo-de-trabajo"><span class="header-section-number">3.2.12</span> Redefinir flujo de trabajo</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb261"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>rf_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(data_rec) <span class="sc">%&gt;%</span></span>
<span id="cb261-3"><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(rf_model_spec,</span>
<span id="cb261-4"><a href="#cb261-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">formula =</span> formula_rf) </span>
<span id="cb261-5"><a href="#cb261-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb261-6"><a href="#cb261-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tune_args</span>(rf_wf) <span class="co">#obtener todos los argumentos ajustables posibles en el flujo de trabajo</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  name  tunable id    source     component   component_id
  &lt;chr&gt; &lt;lgl&gt;   &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;       &lt;chr&gt;       
1 mtry  TRUE    mtry  model_spec rand_forest &lt;NA&gt;        
2 trees TRUE    trees model_spec rand_forest &lt;NA&gt;        
3 min_n TRUE    min_n model_spec rand_forest &lt;NA&gt;        </code></pre>
</div>
</div>
</section>
<section id="extraer-el-conjunto-de-hiperparámetros-del-modelo-con-el-mejor-conjunto-de-variables" class="level3" data-number="3.2.13">
<h3 data-number="3.2.13" class="anchored" data-anchor-id="extraer-el-conjunto-de-hiperparámetros-del-modelo-con-el-mejor-conjunto-de-variables"><span class="header-section-number">3.2.13</span> Extraer el conjunto de hiperparámetros del modelo con el mejor conjunto de variables</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb263"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a>rf_params <span class="ot">&lt;-</span> hardhat<span class="sc">::</span><span class="fu">extract_parameter_set_dials</span>(rf_wf) <span class="sc">%&gt;%</span> </span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>(<span class="at">mtry =</span> <span class="fu">mtry</span>(<span class="at">range =</span> <span class="fu">c</span>(1L, 3L)))</span>
<span id="cb263-3"><a href="#cb263-3" aria-hidden="true" tabindex="-1"></a>rf_params <span class="ot">&lt;-</span> rf_params <span class="sc">%&gt;%</span> </span>
<span id="cb263-4"><a href="#cb263-4" aria-hidden="true" tabindex="-1"></a>  dials<span class="sc">::</span><span class="fu">finalize</span>(rf_params)</span>
<span id="cb263-5"><a href="#cb263-5" aria-hidden="true" tabindex="-1"></a>rf_params</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Collection of 3 parameters for tuning

 identifier  type    object
       mtry  mtry nparam[+]
      trees trees nparam[+]
      min_n min_n nparam[+]</code></pre>
</div>
</div>
</section>
<section id="repetir-búsqueda-del-mejor-conjunto-de-hiperparámtros-mediante-validación-cruzada" class="level3" data-number="3.2.14">
<h3 data-number="3.2.14" class="anchored" data-anchor-id="repetir-búsqueda-del-mejor-conjunto-de-hiperparámtros-mediante-validación-cruzada"><span class="header-section-number">3.2.14</span> Repetir búsqueda del mejor conjunto de Hiperparámtros mediante validación cruzada</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2020</span>)</span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">tic</span>()</span>
<span id="cb265-3"><a href="#cb265-3" aria-hidden="true" tabindex="-1"></a>rf_tune <span class="ot">&lt;-</span></span>
<span id="cb265-4"><a href="#cb265-4" aria-hidden="true" tabindex="-1"></a>  rf_wf <span class="sc">%&gt;%</span></span>
<span id="cb265-5"><a href="#cb265-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_bayes</span>(</span>
<span id="cb265-6"><a href="#cb265-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> data_folds,</span>
<span id="cb265-7"><a href="#cb265-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">param_info =</span> rf_params,</span>
<span id="cb265-8"><a href="#cb265-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># por defecto es 5 (número aleatorio de combinaciones (puntos de grilla) de hiperparámetros)</span></span>
<span id="cb265-9"><a href="#cb265-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">initial =</span> <span class="dv">5</span>, </span>
<span id="cb265-10"><a href="#cb265-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter =</span> <span class="dv">50</span>,</span>
<span id="cb265-11"><a href="#cb265-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> multi_met, <span class="co"># metric_set(rmse,mae,smape),</span></span>
<span id="cb265-12"><a href="#cb265-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">control_bayes</span>(</span>
<span id="cb265-13"><a href="#cb265-13" aria-hidden="true" tabindex="-1"></a>      <span class="co"># El corte entero para el número de iteraciones sin mejores resultados.</span></span>
<span id="cb265-14"><a href="#cb265-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">no_improve =</span> <span class="dv">10</span>,</span>
<span id="cb265-15"><a href="#cb265-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">extract =</span> identity,</span>
<span id="cb265-16"><a href="#cb265-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">save_pred =</span> <span class="cn">TRUE</span>,</span>
<span id="cb265-17"><a href="#cb265-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">verbose =</span> TRUE<span class="co">#,</span></span>
<span id="cb265-18"><a href="#cb265-18" aria-hidden="true" tabindex="-1"></a>      <span class="co"># parallel_over = "resamples"</span></span>
<span id="cb265-19"><a href="#cb265-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb265-20"><a href="#cb265-20" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>❯  Generating a set of 5 initial parameter results</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Initialization complete</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 1 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=156.8 (@iter 0)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4962 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=2, trees=68, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>♥ Newest results:   rmse=154.2 (+/-12.6)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 2 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=154.2 (@iter 1)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4967 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=3, trees=1977, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=163.2 (+/-15.7)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 3 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=154.2 (@iter 1)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4968 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=2, trees=1991, min_n=3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=156.2 (+/-13.7)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 4 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=154.2 (@iter 1)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4960 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=2, trees=18, min_n=3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=162.8 (+/-14.7)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 5 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=154.2 (@iter 1)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4955 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=1, trees=1028, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=171.9 (+/-14.4)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 6 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=154.2 (@iter 1)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4957 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=1, trees=431, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=173.5 (+/-14.7)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 7 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=154.2 (@iter 1)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4956 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=2, trees=1976, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=155.1 (+/-13.1)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 8 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=154.2 (@iter 1)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4963 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=2, trees=951, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=156 (+/-13.6)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 9 ─────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=154.2 (@iter 1)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4962 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=3, trees=31, min_n=2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=165.5 (+/-16.1)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 10 ────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=154.2 (@iter 1)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4957 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=3, trees=1967, min_n=8</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=168.6 (+/-17.8)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Iteration 11 ────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Current best:     rmse=154.2 (@iter 1)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Gaussian process model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Generating 4970 candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Predicted candidates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i mtry=1, trees=1908, min_n=22</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>i Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>✓ Estimating performance</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ⓧ Newest results:   rmse=224.3 (+/-18.2)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>! No improvement for 10 iterations; returning current results.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb403"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb403-1"><a href="#cb403-1" aria-hidden="true" tabindex="-1"></a>tictoc<span class="sc">::</span><span class="fu">toc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>212.86 sec elapsed</code></pre>
</div>
</div>
</section>
<section id="métricas-del-rendimiento-predictivo-en-fase-de-validación-cruzada-con-el-mejor-conjunto-de-variables" class="level3" data-number="3.2.15">
<h3 data-number="3.2.15" class="anchored" data-anchor-id="métricas-del-rendimiento-predictivo-en-fase-de-validación-cruzada-con-el-mejor-conjunto-de-variables"><span class="header-section-number">3.2.15</span> Métricas del rendimiento predictivo en fase de validación cruzada con el mejor conjunto de variables</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb405"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb405-1"><a href="#cb405-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(rf_bayes_tune)</span></span>
<span id="cb405-2"><a href="#cb405-2" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(rf_tune)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter2_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb406"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb406-1"><a href="#cb406-1" aria-hidden="true" tabindex="-1"></a>rf_tune <span class="sc">%&gt;%</span></span>
<span id="cb406-2"><a href="#cb406-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb406-3"><a href="#cb406-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>std_err) <span class="sc">%&gt;%</span></span>
<span id="cb406-4"><a href="#cb406-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> .metric,</span>
<span id="cb406-5"><a href="#cb406-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_from =</span> <span class="fu">c</span>(mean)) <span class="sc">%&gt;%</span></span>
<span id="cb406-6"><a href="#cb406-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(.metric == "rmse") %&gt;%</span></span>
<span id="cb406-7"><a href="#cb406-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(base<span class="sc">::</span>is.numeric, round, <span class="dv">3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb406-8"><a href="#cb406-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(rmse) <span class="sc">%&gt;%</span></span>
<span id="cb406-9"><a href="#cb406-9" aria-hidden="true" tabindex="-1"></a>  reactable<span class="sc">::</span><span class="fu">reactable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div class="reactable html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-c4af2fc21e831b7364b3" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-c4af2fc21e831b7364b3">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"mtry":[2,2,2,2,2,2,3,3,3,1,1,3,1,1,3,2],"trees":[68,1976,951,1991,1944,18,1977,31,1967,1028,431,184,1235,1908,941,714],"min_n":[2,2,2,3,5,3,2,2,8,2,2,18,11,22,32,34],".estimator":["standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard","standard"],"n":[20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20],".config":["Iter1","Iter7","Iter8","Iter3","Preprocessor1_Model3","Iter4","Iter2","Iter9","Iter10","Iter5","Iter6","Preprocessor1_Model5","Preprocessor1_Model4","Iter11","Preprocessor1_Model2","Preprocessor1_Model1"],".iter":[1,7,8,3,0,4,2,9,10,5,6,0,0,11,0,0],"mae":[114.098,115.342,115.706,115.529,115.335,120.602,116.931,118.249,118.542,125.074,126.47,131.194,138.081,164.059,167.396,173.372],"mape":[2.035,2.07,2.087,2.083,2.086,2.165,2.118,2.134,2.172,2.27,2.292,2.427,2.54,3.031,3.155,3.267],"rmse":[154.219,155.142,155.965,156.228,156.834,162.831,163.168,165.481,168.648,171.913,173.49,188.624,190.508,224.296,234.305,237.008],"rsq":[0.986,0.986,0.986,0.986,0.986,0.985,0.983,0.983,0.982,0.983,0.983,0.978,0.979,0.971,0.967,0.967]},"columns":[{"id":"mtry","name":"mtry","type":"numeric"},{"id":"trees","name":"trees","type":"numeric"},{"id":"min_n","name":"min_n","type":"numeric"},{"id":".estimator","name":".estimator","type":"character"},{"id":"n","name":"n","type":"numeric"},{"id":".config","name":".config","type":"character"},{"id":".iter","name":".iter","type":"numeric"},{"id":"mae","name":"mae","type":"numeric"},{"id":"mape","name":"mape","type":"numeric"},{"id":"rmse","name":"rmse","type":"numeric"},{"id":"rsq","name":"rsq","type":"numeric"}],"dataKey":"4bb897185b8032402d9be56fa383014d"},"children":[]},"class":"reactR_markup"},"evals":[],"jsHooks":[]}</script>
</div>
<div class="sourceCode cell-code" id="cb407"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb407-1"><a href="#cb407-1" aria-hidden="true" tabindex="-1"></a>rf_tune <span class="sc">%&gt;%</span></span>
<span id="cb407-2"><a href="#cb407-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb407-3"><a href="#cb407-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(.metric == "rmse") %&gt;%</span></span>
<span id="cb407-4"><a href="#cb407-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.metric, mean, std_err, min_n, mtry, trees</span>
<span id="cb407-5"><a href="#cb407-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb407-6"><a href="#cb407-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(min_n<span class="sc">:</span>mtry<span class="sc">:</span>trees,</span>
<span id="cb407-7"><a href="#cb407-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"value"</span>,</span>
<span id="cb407-8"><a href="#cb407-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"parameter"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb407-9"><a href="#cb407-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(value, mean, <span class="at">color =</span> parameter)) <span class="sc">+</span></span>
<span id="cb407-10"><a href="#cb407-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb407-11"><a href="#cb407-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb407-12"><a href="#cb407-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> mean <span class="sc">-</span> std_err,</span>
<span id="cb407-13"><a href="#cb407-13" aria-hidden="true" tabindex="-1"></a>                    <span class="at">ymax =</span> mean <span class="sc">+</span> std_err)) <span class="sc">+</span></span>
<span id="cb407-14"><a href="#cb407-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(.metric<span class="sc">~</span>parameter, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb407-15"><a href="#cb407-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"RMSE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in x:y: numerical expression has 2 elements: only the first used</code></pre>
</div>
<div class="cell-output-display">
<p><img src="chapter2_files/figure-html/unnamed-chunk-25-3.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="seleccionar-el-mejor-conjunto-de-hiperparámetros-con-el-mejor-conjunto-de-variables" class="level3" data-number="3.2.16">
<h3 data-number="3.2.16" class="anchored" data-anchor-id="seleccionar-el-mejor-conjunto-de-hiperparámetros-con-el-mejor-conjunto-de-variables"><span class="header-section-number">3.2.16</span> Seleccionar el mejor conjunto de hiperparámetros con el mejor conjunto de variables</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb409"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb409-1"><a href="#cb409-1" aria-hidden="true" tabindex="-1"></a>best_rf_model <span class="ot">&lt;-</span> <span class="fu">select_best</span>(rf_tune, <span class="st">"rmse"</span>)</span>
<span id="cb409-2"><a href="#cb409-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb409-3"><a href="#cb409-3" aria-hidden="true" tabindex="-1"></a>final_rf <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(rf_wf,</span>
<span id="cb409-4"><a href="#cb409-4" aria-hidden="true" tabindex="-1"></a>                              best_rf_model)</span>
<span id="cb409-5"><a href="#cb409-5" aria-hidden="true" tabindex="-1"></a>final_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: rand_forest()

── Preprocessor ────────────────────────────────────────────────────────────────
2 Recipe Steps

• step_select()
• step_mutate_at()

── Model ───────────────────────────────────────────────────────────────────────
Random Forest Model Specification (regression)

Main Arguments:
  mtry = 2
  trees = 68
  min_n = 2

Engine-Specific Arguments:
  importance = permutation

Computational engine: ranger </code></pre>
</div>
</div>
</section>
<section id="métricas-del-rendimiento-predictivo-para-el-mejor-conjunto-de-hiperparámetros-con-el-mejor-conjunto-de-variables" class="level3" data-number="3.2.17">
<h3 data-number="3.2.17" class="anchored" data-anchor-id="métricas-del-rendimiento-predictivo-para-el-mejor-conjunto-de-hiperparámetros-con-el-mejor-conjunto-de-variables"><span class="header-section-number">3.2.17</span> Métricas del rendimiento predictivo para el mejor conjunto de hiperparámetros con el mejor conjunto de variables</h3>
<p>Ahora rescatamos las métricas del rendimiento predictivo solo para el mejor conjunto de hiperparámetros en la fase de validación cruzada.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb411"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb411-1"><a href="#cb411-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Métricas promedio de todas las particiones</span></span>
<span id="cb411-2"><a href="#cb411-2" aria-hidden="true" tabindex="-1"></a>metrics_rf <span class="ot">&lt;-</span> </span>
<span id="cb411-3"><a href="#cb411-3" aria-hidden="true" tabindex="-1"></a>  rf_tune <span class="sc">%&gt;%</span> </span>
<span id="cb411-4"><a href="#cb411-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>(<span class="at">summarize =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb411-5"><a href="#cb411-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">modelo =</span> <span class="st">"rf"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb411-6"><a href="#cb411-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(.estimator,.config)) <span class="sc">%&gt;%</span></span>
<span id="cb411-7"><a href="#cb411-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(mtry <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>mtry,</span>
<span id="cb411-8"><a href="#cb411-8" aria-hidden="true" tabindex="-1"></a>                min_n <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>min_n,</span>
<span id="cb411-9"><a href="#cb411-9" aria-hidden="true" tabindex="-1"></a>                trees <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>trees)</span>
<span id="cb411-10"><a href="#cb411-10" aria-hidden="true" tabindex="-1"></a>metrics_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 9
   mtry trees min_n .metric    mean     n  std_err .iter modelo
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;int&gt;    &lt;dbl&gt; &lt;int&gt; &lt;chr&gt; 
1     2    68     2 mae     114.       20  6.62        1 rf    
2     2    68     2 mape      2.04     20  0.273       1 rf    
3     2    68     2 rmse    154.       20 12.6         1 rf    
4     2    68     2 rsq       0.986    20  0.00164     1 rf    </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb413"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb413-1"><a href="#cb413-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Métricas individuales de cada una de las particiones</span></span>
<span id="cb413-2"><a href="#cb413-2" aria-hidden="true" tabindex="-1"></a>metrics_rf_complete <span class="ot">&lt;-</span> </span>
<span id="cb413-3"><a href="#cb413-3" aria-hidden="true" tabindex="-1"></a>  rf_tune <span class="sc">%&gt;%</span> </span>
<span id="cb413-4"><a href="#cb413-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>(<span class="at">summarize =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb413-5"><a href="#cb413-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">modelo =</span> <span class="st">"rf"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb413-6"><a href="#cb413-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(.config)) <span class="sc">%&gt;%</span> </span>
<span id="cb413-7"><a href="#cb413-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id, mtry, min_n, trees, .metric) <span class="sc">%&gt;%</span></span>
<span id="cb413-8"><a href="#cb413-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(dplyr<span class="sc">::</span><span class="fu">across</span>(<span class="fu">c</span>(.estimate),</span>
<span id="cb413-9"><a href="#cb413-9" aria-hidden="true" tabindex="-1"></a>                                 mean)) <span class="sc">%&gt;%</span></span>
<span id="cb413-10"><a href="#cb413-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(mtry <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>mtry,</span>
<span id="cb413-11"><a href="#cb413-11" aria-hidden="true" tabindex="-1"></a>                min_n <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>min_n,</span>
<span id="cb413-12"><a href="#cb413-12" aria-hidden="true" tabindex="-1"></a>                trees <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>trees)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'id', 'mtry', 'min_n', 'trees'. You can
override using the `.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb415"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb415-1"><a href="#cb415-1" aria-hidden="true" tabindex="-1"></a>metrics_rf_complete</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 80 × 6
# Groups:   id, mtry, min_n, trees [20]
   id      mtry min_n trees .metric .estimate
   &lt;chr&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt;
 1 Fold01     2     2    68 mae       126.   
 2 Fold01     2     2    68 mape        2.18 
 3 Fold01     2     2    68 rmse      140.   
 4 Fold01     2     2    68 rsq         0.991
 5 Fold02     2     2    68 mae       111.   
 6 Fold02     2     2    68 mape        2.12 
 7 Fold02     2     2    68 rmse      181.   
 8 Fold02     2     2    68 rsq         0.984
 9 Fold03     2     2    68 mae       124.   
10 Fold03     2     2    68 mape        1.83 
# … with 70 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb417"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb417-1"><a href="#cb417-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Valores de validación (mae y rmse) obtenidos en cada partición y repetición.</span></span>
<span id="cb417-2"><a href="#cb417-2" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb417-3"><a href="#cb417-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> metrics_rf_complete,</span>
<span id="cb417-4"><a href="#cb417-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> .estimate, <span class="at">fill =</span> .metric)) <span class="sc">+</span></span>
<span id="cb417-5"><a href="#cb417-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb417-6"><a href="#cb417-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb417-7"><a href="#cb417-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(. <span class="sc">~</span> .metric, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb417-8"><a href="#cb417-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb417-9"><a href="#cb417-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> metrics_rf <span class="sc">%&gt;%</span> </span>
<span id="cb417-10"><a href="#cb417-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="st">".estimate"</span> <span class="ot">=</span> <span class="st">"mean"</span>),</span>
<span id="cb417-11"><a href="#cb417-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">xintercept =</span> .estimate, <span class="at">colour =</span> .metric), <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="dv">1</span>,</span>
<span id="cb417-12"><a href="#cb417-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="dv">2</span></span>
<span id="cb417-13"><a href="#cb417-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb417-14"><a href="#cb417-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x=</span><span class="fu">element_text</span>(<span class="at">angle=</span><span class="dv">90</span>, <span class="at">hjust=</span><span class="fl">0.5</span>))</span>
<span id="cb417-15"><a href="#cb417-15" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb417-16"><a href="#cb417-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> metrics_rf_complete,</span>
<span id="cb417-17"><a href="#cb417-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> .metric, <span class="at">y =</span> .estimate, <span class="at">fill =</span> .metric, <span class="at">color =</span> .metric)) <span class="sc">+</span></span>
<span id="cb417-18"><a href="#cb417-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">outlier.shape =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb417-19"><a href="#cb417-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">width =</span> <span class="fl">0.05</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb417-20"><a href="#cb417-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># coord_flip() +</span></span>
<span id="cb417-21"><a href="#cb417-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb417-22"><a href="#cb417-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> metrics_rf <span class="sc">%&gt;%</span> </span>
<span id="cb417-23"><a href="#cb417-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="st">".estimate"</span> <span class="ot">=</span> <span class="st">"mean"</span>),</span>
<span id="cb417-24"><a href="#cb417-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb417-25"><a href="#cb417-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb417-26"><a href="#cb417-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb417-27"><a href="#cb417-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(.metric <span class="sc">~</span> ., <span class="at">scales =</span> <span class="st">"free"</span>) </span>
<span id="cb417-28"><a href="#cb417-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb417-29"><a href="#cb417-29" aria-hidden="true" tabindex="-1"></a>ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(p1, p2, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">common.legend =</span> <span class="cn">TRUE</span>, <span class="at">align =</span> <span class="st">"v"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb417-30"><a href="#cb417-30" aria-hidden="true" tabindex="-1"></a>  ggpubr<span class="sc">::</span><span class="fu">annotate_figure</span>(</span>
<span id="cb417-31"><a href="#cb417-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">top =</span> ggpubr<span class="sc">::</span><span class="fu">text_grob</span>(<span class="st">"Distribución errores de validación cruzada"</span>, <span class="at">size =</span> <span class="dv">15</span>)</span>
<span id="cb417-32"><a href="#cb417-32" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter2_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb418"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb418-1"><a href="#cb418-1" aria-hidden="true" tabindex="-1"></a>validation_rf_predictions <span class="ot">&lt;-</span> </span>
<span id="cb418-2"><a href="#cb418-2" aria-hidden="true" tabindex="-1"></a>  rf_tune <span class="sc">%&gt;%</span> </span>
<span id="cb418-3"><a href="#cb418-3" aria-hidden="true" tabindex="-1"></a>  tune<span class="sc">::</span><span class="fu">collect_predictions</span>(<span class="at">summarize =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb418-4"><a href="#cb418-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">modelo =</span> <span class="st">"rf"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb418-5"><a href="#cb418-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(mtry <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>mtry,</span>
<span id="cb418-6"><a href="#cb418-6" aria-hidden="true" tabindex="-1"></a>                min_n <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>min_n,</span>
<span id="cb418-7"><a href="#cb418-7" aria-hidden="true" tabindex="-1"></a>                trees <span class="sc">%in%</span> best_rf_model<span class="sc">$</span>trees)</span>
<span id="cb418-8"><a href="#cb418-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb418-9"><a href="#cb418-9" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb418-10"><a href="#cb418-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> validation_rf_predictions,</span>
<span id="cb418-11"><a href="#cb418-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> yield, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb418-12"><a href="#cb418-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb418-13"><a href="#cb418-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"firebrick"</span>) <span class="sc">+</span></span>
<span id="cb418-14"><a href="#cb418-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Valor predicho vs valor real"</span>) <span class="sc">+</span></span>
<span id="cb418-15"><a href="#cb418-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb418-16"><a href="#cb418-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb418-17"><a href="#cb418-17" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb418-18"><a href="#cb418-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> validation_rf_predictions,</span>
<span id="cb418-19"><a href="#cb418-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> .row, <span class="at">y =</span> yield <span class="sc">-</span> .pred)</span>
<span id="cb418-20"><a href="#cb418-20" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb418-21"><a href="#cb418-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb418-22"><a href="#cb418-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span>  <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"firebrick"</span>) <span class="sc">+</span></span>
<span id="cb418-23"><a href="#cb418-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residuos del modelo"</span>) <span class="sc">+</span></span>
<span id="cb418-24"><a href="#cb418-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb418-25"><a href="#cb418-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb418-26"><a href="#cb418-26" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb418-27"><a href="#cb418-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> validation_rf_predictions,</span>
<span id="cb418-28"><a href="#cb418-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> yield <span class="sc">-</span> .pred)</span>
<span id="cb418-29"><a href="#cb418-29" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb418-30"><a href="#cb418-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span> </span>
<span id="cb418-31"><a href="#cb418-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribución residuos del modelo"</span>) <span class="sc">+</span></span>
<span id="cb418-32"><a href="#cb418-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb418-33"><a href="#cb418-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb418-34"><a href="#cb418-34" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb418-35"><a href="#cb418-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> validation_rf_predictions,</span>
<span id="cb418-36"><a href="#cb418-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">sample =</span> yield <span class="sc">-</span> .pred)</span>
<span id="cb418-37"><a href="#cb418-37" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb418-38"><a href="#cb418-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_qq</span>() <span class="sc">+</span></span>
<span id="cb418-39"><a href="#cb418-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_qq_line</span>(<span class="at">color =</span> <span class="st">"firebrick"</span>) <span class="sc">+</span></span>
<span id="cb418-40"><a href="#cb418-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Q-Q residuos del modelo"</span>) <span class="sc">+</span></span>
<span id="cb418-41"><a href="#cb418-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb418-42"><a href="#cb418-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb418-43"><a href="#cb418-43" aria-hidden="true" tabindex="-1"></a>ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(<span class="at">plotlist =</span> <span class="fu">list</span>(p1, p2, p3, p4)) <span class="sc">%&gt;%</span></span>
<span id="cb418-44"><a href="#cb418-44" aria-hidden="true" tabindex="-1"></a>  ggpubr<span class="sc">::</span><span class="fu">annotate_figure</span>(</span>
<span id="cb418-45"><a href="#cb418-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">top =</span> ggpubr<span class="sc">::</span><span class="fu">text_grob</span>(<span class="st">"Distribución residuos"</span>, <span class="at">size =</span> <span class="dv">15</span>, <span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb418-46"><a href="#cb418-46" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter2_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="entrenamiento-del-modelo-final-con-el-mejor-conjunto-de-variables" class="level3" data-number="3.2.18">
<h3 data-number="3.2.18" class="anchored" data-anchor-id="entrenamiento-del-modelo-final-con-el-mejor-conjunto-de-variables"><span class="header-section-number">3.2.18</span> Entrenamiento del modelo final con el mejor conjunto de variables</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb419"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb419-1"><a href="#cb419-1" aria-hidden="true" tabindex="-1"></a>rf_model <span class="ot">&lt;-</span> final_rf <span class="sc">%&gt;%</span></span>
<span id="cb419-2"><a href="#cb419-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(data_train) <span class="sc">%&gt;%</span></span>
<span id="cb419-3"><a href="#cb419-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="verificación-de-la-importancia-de-variables" class="level3" data-number="3.2.19">
<h3 data-number="3.2.19" class="anchored" data-anchor-id="verificación-de-la-importancia-de-variables"><span class="header-section-number">3.2.19</span> Verificación de la importancia de variables</h3>
<p>Ya que hemos creado un modelo con todas las variables, es necesario revisar si existe alguna variable que aporta de forma negativa en el performance predictivo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb420"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb420-1"><a href="#cb420-1" aria-hidden="true" tabindex="-1"></a><span class="co"># vip::vip(rf_model, num_features = 60)</span></span>
<span id="cb420-2"><a href="#cb420-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb420-3"><a href="#cb420-3" aria-hidden="true" tabindex="-1"></a>vi_rf <span class="ot">&lt;-</span> </span>
<span id="cb420-4"><a href="#cb420-4" aria-hidden="true" tabindex="-1"></a>  rf_model <span class="sc">%&gt;%</span></span>
<span id="cb420-5"><a href="#cb420-5" aria-hidden="true" tabindex="-1"></a>  vip<span class="sc">::</span><span class="fu">vi</span>() <span class="sc">%&gt;%</span></span>
<span id="cb420-6"><a href="#cb420-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Sign =</span> <span class="fu">ifelse</span>(Importance <span class="sc">&gt;=</span> <span class="dv">0</span>, <span class="st">"POS"</span>, <span class="st">"NEG"</span>),</span>
<span id="cb420-7"><a href="#cb420-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Importance =</span> <span class="fu">abs</span>(Importance),</span>
<span id="cb420-8"><a href="#cb420-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Variable =</span> <span class="fu">fct_reorder</span>(Variable, Importance),</span>
<span id="cb420-9"><a href="#cb420-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total_Importance =</span> <span class="fu">sum</span>(Importance),</span>
<span id="cb420-10"><a href="#cb420-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Importance =</span> Importance<span class="sc">/</span>Total_Importance) <span class="sc">%&gt;%</span></span>
<span id="cb420-11"><a href="#cb420-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dplyr::filter(!Importance == 0) %&gt;%</span></span>
<span id="cb420-12"><a href="#cb420-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Importance,</span>
<span id="cb420-13"><a href="#cb420-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> Variable,</span>
<span id="cb420-14"><a href="#cb420-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">fill =</span> Sign)) <span class="sc">+</span></span>
<span id="cb420-15"><a href="#cb420-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb420-16"><a href="#cb420-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(Importance,<span class="dv">4</span>),</span>
<span id="cb420-17"><a href="#cb420-17" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> Variable),</span>
<span id="cb420-18"><a href="#cb420-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb420-19"><a href="#cb420-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="st">"NEG"</span>,<span class="st">"POS"</span>),</span>
<span id="cb420-20"><a href="#cb420-20" aria-hidden="true" tabindex="-1"></a>                    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"red"</span>,<span class="st">"blue"</span>)) <span class="sc">+</span></span>
<span id="cb420-21"><a href="#cb420-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">expand =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb420-22"><a href="#cb420-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="cn">NULL</span>)</span>
<span id="cb420-23"><a href="#cb420-23" aria-hidden="true" tabindex="-1"></a>vi_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter2_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="rescatando-las-especififaciones-del-modelo-para-futuras-recalibraciones" class="level4" data-number="3.2.19.1">
<h4 data-number="3.2.19.1" class="anchored" data-anchor-id="rescatando-las-especififaciones-del-modelo-para-futuras-recalibraciones"><span class="header-section-number">3.2.19.1</span> Rescatando las especififaciones del modelo para futuras recalibraciones</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb421"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb421-1"><a href="#cb421-1" aria-hidden="true" tabindex="-1"></a>spec <span class="ot">&lt;-</span> rf_model <span class="sc">%&gt;%</span> <span class="fu">extract_spec_parsnip</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="testeo-interno" class="level3" data-number="3.2.20">
<h3 data-number="3.2.20" class="anchored" data-anchor-id="testeo-interno"><span class="header-section-number">3.2.20</span> Testeo interno</h3>
<p>Ahora, testeamos el modelo final con los datos de prueba (data_test).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb422"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb422-1"><a href="#cb422-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Testeo interno ----</span></span>
<span id="cb422-2"><a href="#cb422-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb422-3"><a href="#cb422-3" aria-hidden="true" tabindex="-1"></a><span class="co"># PREDICCIÓN </span><span class="al">TEST</span><span class="co"> ----</span></span>
<span id="cb422-4"><a href="#cb422-4" aria-hidden="true" tabindex="-1"></a><span class="co"># =============================================================================</span></span>
<span id="cb422-5"><a href="#cb422-5" aria-hidden="true" tabindex="-1"></a>predicciones <span class="ot">&lt;-</span> rf_model <span class="sc">%&gt;%</span></span>
<span id="cb422-6"><a href="#cb422-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(</span>
<span id="cb422-7"><a href="#cb422-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_data =</span> data_test_prep,</span>
<span id="cb422-8"><a href="#cb422-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"numeric"</span></span>
<span id="cb422-9"><a href="#cb422-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb422-10"><a href="#cb422-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb422-11"><a href="#cb422-11" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTRICAS </span><span class="al">TEST</span><span class="co"> ----</span></span>
<span id="cb422-12"><a href="#cb422-12" aria-hidden="true" tabindex="-1"></a><span class="co"># =============================================================================</span></span>
<span id="cb422-13"><a href="#cb422-13" aria-hidden="true" tabindex="-1"></a>predicciones_rf <span class="ot">&lt;-</span> predicciones <span class="sc">%&gt;%</span> </span>
<span id="cb422-14"><a href="#cb422-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(data_test_prep <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(yield)) <span class="sc">%&gt;%</span></span>
<span id="cb422-15"><a href="#cb422-15" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">modelo =</span> <span class="st">"rf"</span>)</span>
<span id="cb422-16"><a href="#cb422-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb422-17"><a href="#cb422-17" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(predicciones_rf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     .pred          yield         modelo         
 Min.   :3494   Min.   :3049   Length:127        
 1st Qu.:5832   1st Qu.:5792   Class :character  
 Median :6756   Median :6796   Mode  :character  
 Mean   :6629   Mean   :6616                     
 3rd Qu.:7458   3rd Qu.:7434                     
 Max.   :8691   Max.   :8562                     </code></pre>
</div>
<div class="sourceCode cell-code" id="cb424"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb424-1"><a href="#cb424-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Error de test</span></span>
<span id="cb424-2"><a href="#cb424-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb424-3"><a href="#cb424-3" aria-hidden="true" tabindex="-1"></a>error_test_rf  <span class="ot">&lt;-</span> <span class="fu">multi_met</span>(</span>
<span id="cb424-4"><a href="#cb424-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data     =</span> predicciones_rf,</span>
<span id="cb424-5"><a href="#cb424-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">truth    =</span> yield,</span>
<span id="cb424-6"><a href="#cb424-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate =</span> .pred,</span>
<span id="cb424-7"><a href="#cb424-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">na_rm    =</span> <span class="cn">TRUE</span></span>
<span id="cb424-8"><a href="#cb424-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb424-9"><a href="#cb424-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb424-10"><a href="#cb424-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">modelo =</span> <span class="st">"rf"</span></span>
<span id="cb424-11"><a href="#cb424-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb424-12"><a href="#cb424-12" aria-hidden="true" tabindex="-1"></a>error_test_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
  .metric .estimator .estimate modelo
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; 
1 rmse    standard     137.    rf    
2 rsq     standard       0.987 rf    
3 mape    standard       1.76  rf    
4 mae     standard     108.    rf    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb426"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb426-1"><a href="#cb426-1" aria-hidden="true" tabindex="-1"></a>combo_plot <span class="ot">&lt;-</span> metrics_rf_complete <span class="sc">%&gt;%</span> </span>
<span id="cb426-2"><a href="#cb426-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .metric, <span class="at">y =</span> .estimate)) <span class="sc">+</span></span>
<span id="cb426-3"><a href="#cb426-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb426-4"><a href="#cb426-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">width =</span> <span class="fl">0.3</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb426-5"><a href="#cb426-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb426-6"><a href="#cb426-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> metrics_rf <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="st">".estimate"</span> <span class="ot">=</span> <span class="st">"mean"</span>),</span>
<span id="cb426-7"><a href="#cb426-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"green"</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb426-8"><a href="#cb426-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb426-9"><a href="#cb426-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb426-10"><a href="#cb426-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> error_test_rf,</span>
<span id="cb426-11"><a href="#cb426-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">2</span></span>
<span id="cb426-12"><a href="#cb426-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb426-13"><a href="#cb426-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(.metric<span class="sc">~</span>., <span class="at">scales =</span> <span class="st">"free"</span>)</span>
<span id="cb426-14"><a href="#cb426-14" aria-hidden="true" tabindex="-1"></a>combo_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter2_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb427"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb427-1"><a href="#cb427-1" aria-hidden="true" tabindex="-1"></a>pe1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb427-2"><a href="#cb427-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> predicciones_rf,</span>
<span id="cb427-3"><a href="#cb427-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> yield, <span class="at">y =</span> .pred)</span>
<span id="cb427-4"><a href="#cb427-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb427-5"><a href="#cb427-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb427-6"><a href="#cb427-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"firebrick"</span>) <span class="sc">+</span></span>
<span id="cb427-7"><a href="#cb427-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Valor predicho vs valor real"</span>) <span class="sc">+</span></span>
<span id="cb427-8"><a href="#cb427-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb427-9"><a href="#cb427-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb427-10"><a href="#cb427-10" aria-hidden="true" tabindex="-1"></a>pe2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb427-11"><a href="#cb427-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> predicciones_rf,</span>
<span id="cb427-12"><a href="#cb427-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(predicciones_rf), <span class="at">y =</span> yield <span class="sc">-</span> .pred)</span>
<span id="cb427-13"><a href="#cb427-13" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb427-14"><a href="#cb427-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb427-15"><a href="#cb427-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span>  <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"firebrick"</span>) <span class="sc">+</span></span>
<span id="cb427-16"><a href="#cb427-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residuos del modelo"</span>,</span>
<span id="cb427-17"><a href="#cb427-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">".row"</span>)   <span class="sc">+</span></span>
<span id="cb427-18"><a href="#cb427-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb427-19"><a href="#cb427-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb427-20"><a href="#cb427-20" aria-hidden="true" tabindex="-1"></a>pe3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb427-21"><a href="#cb427-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> predicciones_rf,</span>
<span id="cb427-22"><a href="#cb427-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> yield <span class="sc">-</span> .pred)</span>
<span id="cb427-23"><a href="#cb427-23" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb427-24"><a href="#cb427-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span> </span>
<span id="cb427-25"><a href="#cb427-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribución residuos del modelo"</span>) <span class="sc">+</span></span>
<span id="cb427-26"><a href="#cb427-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb427-27"><a href="#cb427-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb427-28"><a href="#cb427-28" aria-hidden="true" tabindex="-1"></a>pe4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb427-29"><a href="#cb427-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> predicciones_rf,</span>
<span id="cb427-30"><a href="#cb427-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">sample =</span> yield <span class="sc">-</span> .pred)</span>
<span id="cb427-31"><a href="#cb427-31" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb427-32"><a href="#cb427-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_qq</span>() <span class="sc">+</span></span>
<span id="cb427-33"><a href="#cb427-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_qq_line</span>(<span class="at">color =</span> <span class="st">"firebrick"</span>) <span class="sc">+</span></span>
<span id="cb427-34"><a href="#cb427-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Q-Q residuos del modelo"</span>) <span class="sc">+</span></span>
<span id="cb427-35"><a href="#cb427-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb427-36"><a href="#cb427-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb427-37"><a href="#cb427-37" aria-hidden="true" tabindex="-1"></a>ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(<span class="at">plotlist =</span> <span class="fu">list</span>(pe1, pe2, pe3, pe4)) <span class="sc">%&gt;%</span></span>
<span id="cb427-38"><a href="#cb427-38" aria-hidden="true" tabindex="-1"></a>  ggpubr<span class="sc">::</span><span class="fu">annotate_figure</span>(</span>
<span id="cb427-39"><a href="#cb427-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">top =</span> ggpubr<span class="sc">::</span><span class="fu">text_grob</span>(<span class="st">"Distribución residuos"</span>, <span class="at">size =</span> <span class="dv">15</span>, <span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb427-40"><a href="#cb427-40" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter2_files/figure-html/unnamed-chunk-34-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Se puede observar que no hay evidencia de sobreajuste.</p>
</section>
<section id="recalibración-inicial-del-modelo" class="level3" data-number="3.2.21">
<h3 data-number="3.2.21" class="anchored" data-anchor-id="recalibración-inicial-del-modelo"><span class="header-section-number">3.2.21</span> Recalibración inicial del modelo</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb428"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb428-1"><a href="#cb428-1" aria-hidden="true" tabindex="-1"></a>rf_model_rec <span class="ot">&lt;-</span> rf_model <span class="sc">%&gt;%</span></span>
<span id="cb428-2"><a href="#cb428-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_spec_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb428-3"><a href="#cb428-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(</span>
<span id="cb428-4"><a href="#cb428-4" aria-hidden="true" tabindex="-1"></a>    formula_rf,</span>
<span id="cb428-5"><a href="#cb428-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">bind_rows</span>(data_train_prep,</span>
<span id="cb428-6"><a href="#cb428-6" aria-hidden="true" tabindex="-1"></a>                     data_test_prep))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="testeo-externo" class="level3" data-number="3.2.22">
<h3 data-number="3.2.22" class="anchored" data-anchor-id="testeo-externo"><span class="header-section-number">3.2.22</span> Testeo externo</h3>
<p>Finalmente, el testeo externo con el conjunto de datos para testeo externo (data_new).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb429"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb429-1"><a href="#cb429-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Testeo externo ----</span></span>
<span id="cb429-2"><a href="#cb429-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb429-3"><a href="#cb429-3" aria-hidden="true" tabindex="-1"></a><span class="co"># PREDICCIÓN </span><span class="al">TEST</span><span class="co"> ----</span></span>
<span id="cb429-4"><a href="#cb429-4" aria-hidden="true" tabindex="-1"></a><span class="co"># =============================================================================</span></span>
<span id="cb429-5"><a href="#cb429-5" aria-hidden="true" tabindex="-1"></a>predicciones_ext <span class="ot">&lt;-</span> rf_model_rec <span class="sc">%&gt;%</span></span>
<span id="cb429-6"><a href="#cb429-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(</span>
<span id="cb429-7"><a href="#cb429-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_data =</span> data_new_prep,</span>
<span id="cb429-8"><a href="#cb429-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"numeric"</span></span>
<span id="cb429-9"><a href="#cb429-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb429-10"><a href="#cb429-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb429-11"><a href="#cb429-11" aria-hidden="true" tabindex="-1"></a><span class="co"># MÉTRICAS </span><span class="al">TEST</span><span class="co"> ----</span></span>
<span id="cb429-12"><a href="#cb429-12" aria-hidden="true" tabindex="-1"></a><span class="co"># =============================================================================</span></span>
<span id="cb429-13"><a href="#cb429-13" aria-hidden="true" tabindex="-1"></a>predicciones_rf_ext <span class="ot">&lt;-</span> predicciones_ext <span class="sc">%&gt;%</span> </span>
<span id="cb429-14"><a href="#cb429-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(data_new_prep <span class="sc">%&gt;%</span> <span class="fu">select</span>(yield)) <span class="sc">%&gt;%</span></span>
<span id="cb429-15"><a href="#cb429-15" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">modelo =</span> <span class="st">"rf"</span>)</span>
<span id="cb429-16"><a href="#cb429-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb429-17"><a href="#cb429-17" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(predicciones_rf_ext)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     .pred          yield         modelo         
 Min.   :2564   Min.   :1946   Length:354        
 1st Qu.:4436   1st Qu.:4514   Class :character  
 Median :5326   Median :5555   Mode  :character  
 Mean   :5201   Mean   :5360                     
 3rd Qu.:5919   3rd Qu.:6237                     
 Max.   :7263   Max.   :7805                     </code></pre>
</div>
<div class="sourceCode cell-code" id="cb431"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb431-1"><a href="#cb431-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Error de test</span></span>
<span id="cb431-2"><a href="#cb431-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb431-3"><a href="#cb431-3" aria-hidden="true" tabindex="-1"></a>error_test_rf_ext  <span class="ot">&lt;-</span> <span class="fu">multi_met</span>(</span>
<span id="cb431-4"><a href="#cb431-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data     =</span> predicciones_rf_ext,</span>
<span id="cb431-5"><a href="#cb431-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">truth    =</span> yield,</span>
<span id="cb431-6"><a href="#cb431-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate =</span> .pred,</span>
<span id="cb431-7"><a href="#cb431-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">na_rm    =</span> <span class="cn">TRUE</span></span>
<span id="cb431-8"><a href="#cb431-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb431-9"><a href="#cb431-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb431-10"><a href="#cb431-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">modelo =</span> <span class="st">"rf"</span></span>
<span id="cb431-11"><a href="#cb431-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb431-12"><a href="#cb431-12" aria-hidden="true" tabindex="-1"></a>error_test_rf_ext</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
  .metric .estimator .estimate modelo
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; 
1 rmse    standard     316.    rf    
2 rsq     standard       0.957 rf    
3 mape    standard       4.92  rf    
4 mae     standard     254.    rf    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb433"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb433-1"><a href="#cb433-1" aria-hidden="true" tabindex="-1"></a>combo_plot <span class="ot">&lt;-</span> metrics_rf_complete <span class="sc">%&gt;%</span></span>
<span id="cb433-2"><a href="#cb433-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .metric, <span class="at">y =</span> .estimate)) <span class="sc">+</span></span>
<span id="cb433-3"><a href="#cb433-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb433-4"><a href="#cb433-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">width =</span> <span class="fl">0.3</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb433-5"><a href="#cb433-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb433-6"><a href="#cb433-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> metrics_rf <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="st">".estimate"</span> <span class="ot">=</span> <span class="st">"mean"</span>),</span>
<span id="cb433-7"><a href="#cb433-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"green"</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb433-8"><a href="#cb433-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb433-9"><a href="#cb433-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb433-10"><a href="#cb433-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> error_test_rf,</span>
<span id="cb433-11"><a href="#cb433-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb433-12"><a href="#cb433-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb433-13"><a href="#cb433-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb433-14"><a href="#cb433-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> error_test_rf_ext,</span>
<span id="cb433-15"><a href="#cb433-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.5</span></span>
<span id="cb433-16"><a href="#cb433-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb433-17"><a href="#cb433-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(.metric<span class="sc">~</span>., <span class="at">scales =</span> <span class="st">"free"</span>)</span>
<span id="cb433-18"><a href="#cb433-18" aria-hidden="true" tabindex="-1"></a>combo_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter2_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb434"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb434-1"><a href="#cb434-1" aria-hidden="true" tabindex="-1"></a>pe1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb434-2"><a href="#cb434-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> predicciones_rf_ext,</span>
<span id="cb434-3"><a href="#cb434-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> yield, <span class="at">y =</span> .pred)</span>
<span id="cb434-4"><a href="#cb434-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb434-5"><a href="#cb434-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb434-6"><a href="#cb434-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"firebrick"</span>) <span class="sc">+</span></span>
<span id="cb434-7"><a href="#cb434-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Valor predicho vs valor real"</span>) <span class="sc">+</span></span>
<span id="cb434-8"><a href="#cb434-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb434-9"><a href="#cb434-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-10"><a href="#cb434-10" aria-hidden="true" tabindex="-1"></a>pe2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb434-11"><a href="#cb434-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> predicciones_rf_ext,</span>
<span id="cb434-12"><a href="#cb434-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(predicciones_rf_ext), <span class="at">y =</span> yield <span class="sc">-</span> .pred)</span>
<span id="cb434-13"><a href="#cb434-13" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb434-14"><a href="#cb434-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb434-15"><a href="#cb434-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span>  <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"firebrick"</span>) <span class="sc">+</span></span>
<span id="cb434-16"><a href="#cb434-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residuos del modelo"</span>,</span>
<span id="cb434-17"><a href="#cb434-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">".row"</span>)   <span class="sc">+</span></span>
<span id="cb434-18"><a href="#cb434-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb434-19"><a href="#cb434-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-20"><a href="#cb434-20" aria-hidden="true" tabindex="-1"></a>pe3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb434-21"><a href="#cb434-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> predicciones_rf_ext,</span>
<span id="cb434-22"><a href="#cb434-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> yield <span class="sc">-</span> .pred)</span>
<span id="cb434-23"><a href="#cb434-23" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb434-24"><a href="#cb434-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span> </span>
<span id="cb434-25"><a href="#cb434-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribución residuos del modelo"</span>) <span class="sc">+</span></span>
<span id="cb434-26"><a href="#cb434-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb434-27"><a href="#cb434-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-28"><a href="#cb434-28" aria-hidden="true" tabindex="-1"></a>pe4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb434-29"><a href="#cb434-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> predicciones_rf_ext,</span>
<span id="cb434-30"><a href="#cb434-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">sample =</span> yield <span class="sc">-</span> .pred)</span>
<span id="cb434-31"><a href="#cb434-31" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb434-32"><a href="#cb434-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_qq</span>() <span class="sc">+</span></span>
<span id="cb434-33"><a href="#cb434-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_qq_line</span>(<span class="at">color =</span> <span class="st">"firebrick"</span>) <span class="sc">+</span></span>
<span id="cb434-34"><a href="#cb434-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Q-Q residuos del modelo"</span>) <span class="sc">+</span></span>
<span id="cb434-35"><a href="#cb434-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb434-36"><a href="#cb434-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb434-37"><a href="#cb434-37" aria-hidden="true" tabindex="-1"></a>ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(<span class="at">plotlist =</span> <span class="fu">list</span>(pe1, pe2, pe3, pe4)) <span class="sc">%&gt;%</span></span>
<span id="cb434-38"><a href="#cb434-38" aria-hidden="true" tabindex="-1"></a>  ggpubr<span class="sc">::</span><span class="fu">annotate_figure</span>(</span>
<span id="cb434-39"><a href="#cb434-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">top =</span> ggpubr<span class="sc">::</span><span class="fu">text_grob</span>(<span class="st">"Distribución residuos"</span>, <span class="at">size =</span> <span class="dv">15</span>, <span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb434-40"><a href="#cb434-40" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="chapter2_files/figure-html/unnamed-chunk-36-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Con el nuevo conjunto de variables, se puede observar que el rendimiento predictivo del modelo tiene una variancia un poco mayor en comparación al modelo lineal general.</p>
</section>
</section>
<section id="discusión" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="discusión"><span class="header-section-number">3.3</span> Discusión</h2>
<p>Una de las cosas que discuto regularmente es el uso de modelos no paramétricos en <em>Crop Yield Forecast</em>. Sucede que estos modelos requieren de mayor cantidad de datos a comparación de los modelos paramétricos y adicionalmente tienden a tener un mayor riesgo de sobreajuste en problemas de regresión. Por ello, los modelos no paramétricos son más recomendados en problemas de clasificación y cuando se tiene una gran cantidad de datos.</p>
<p>En mi corta experiencia, he notado que tener una gran cantidad de datos históricos en empresas de agroexportación es muy difícil, debido a que regularmente se instalan nuevas variadades de cultivos o por otro lado, las empresas deciden producir nuevos productos agrícolas debido al crecimiento de su demanda y/o de su precio.</p>
<p>Es por este problema que mi recomendación es usar modelos paramétricos cuando se inicia un proyecto de <em>Crop Yield Forecast</em>, hasta que se tenga la suficiente información histórica para cambiar los procesos con algoritmos no paramétricos.</p>
<p>Por otro lado, los modelos paramétricos son menos costosos computacionalmente a comparación de los no paramétricos, por ello, son muy útiles para experimentar con nuevas técnicas de preprocesamiento, procesos de validación de los modelos o aplicar alguna innovación.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } 
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./chapter1.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Modelamiento en tidymodels con el motor lm.</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./chapter3.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Revisión de muchos modelos y Ensamblado de modelos en tidymodels.</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>